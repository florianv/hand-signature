<!--
This file is part of hand-signature.

(c) Florian Voutzinos <florian@voutzinos.com>

For the full copyright and license information, please view the LICENSE
file that was distributed with this source code.
-->

<link rel="import" href="../polymer/polymer.html">

<!--
Web Component for handwritten signatures.

@element hand-signature
@blurb Web Component for handwritten signatures.
@status alpha
@homepage https://github.com/florianv/hand-signature
-->
<dom-module id="hand-signature">
    <template>

        <link rel="stylesheet" href="hand-signature.css"/>

        <section id="box">
            <header>
                <content select="h1"></content>
            </header>

            <canvas
                id="signature"
                on-track="onTrack">
            </canvas>

            <template if="{{clearable}}">
                <footer>
                    <button on-click="{{clear}}">&times;</button>
                </footer>
            </template>
        </section>

    </template>

    <script>
        Polymer({
            is:'hand-signature',

            properties:{
                /**
                 * Width of the element and canvas.
                 */
                width: {
                    type: String,
                    value: '300px',
                    notify: true
                },

                /**
                 * Height of the canvas.
                 */
                height: {
                    type: String,
                    value: '200px',
                    notify: true
                },

                /**
                 * The line color.
                 */
                lineColor: {
                    type: String,
                    value: '#212121'
                },

                /**
                 * The line join.
                 * Possible values: bevel, round, miter.
                 */
                lineJoin: {
                    type: String,
                    value: 'miter'
                },

                /**
                 * The line width.
                 */
                lineWidth: {
                    type: Number,
                    value: 2
                },

                /**
                 * The canvas background color.
                 */
                backgroundColor: {
                    type: String,
                    value: '#FFFFFF'
                },

                /**
                 * True if the signature can be cleared.
                 */
                clearable: {
                    type: Boolean,
                    value: true
                },

                /**
                 * The image format.
                 */
                format: {
                    type: String,
                    value: 'png'
                },

                /**
                 * The image data.
                 */
                data: {
                    type: String,
                    value: null,
                    notify: true
                }
            },

            created: function () {
                this.signing = false;
                this.lines = [];
            },

            attached: function () {
                this.$.signature.width = this.getWidthWithoutUnit();
                this.$.signature.height = this.getHeightWithoutUnit();

                this.context = this.$.signature.getContext('2d');
                this.context.strokeStyle = this.lineColor;
                this.context.fillStyle = this.backgroundColor;
                this.context.lineJoin = this.lineJoin;
                this.context.lineWidth = this.lineWidth;
                this.$.box.style.width = this.width;

                this.fillBackground();
            },

            onTrack: function(e) {
                switch(e.detail.state) {
                    case 'start':
                        this.signing = true;
                        this.lines.push([]);
                        break;

                    case 'track':
                        var rect = this.$.signature.getBoundingClientRect();
                        var mouseX = e.detail.x - rect.left;
                        var mouseY = e.detail.y - rect.top;

                        if (this.signing) {
                            this.lines[this.lines.length - 1].push({
                                x: mouseX,
                                y: mouseY
                            });

                            this.doDraw();
                            this.updateData();
                        }
                        break;

                    case 'end':
                        this.signing = false;
                        this.lines.push([]);
                        break;
                }
            },

            doDraw: function () {
                for (var i = 0; i < this.lines.length; i++) {
                    var points = this.lines[i];

                    this.context.beginPath();

                    for (var j = 0; j < points.length; j++) {
                        var previousPoint = j > 0 ? points[j - 1] : null;
                        var currentPoint = points[j];

                        this.context.moveTo(currentPoint.x, currentPoint.y);

                        if (previousPoint) {
                            this.context.lineTo(previousPoint.x, previousPoint.y);
                        }
                    }
                    this.context.closePath();
                    this.context.stroke();
                }
            },

            clear: function () {
                this.context.clearRect(0, 0, this.getWidthWithoutUnit(), this.getHeightWithoutUnit());
                this.lines = [];
                this.fillBackground();
            },

            fillBackground: function () {
                this.context.fillRect(0, 0, this.getWidthWithoutUnit(), this.getHeightWithoutUnit());
            },

            updateData: function () {
                var format = 'image/' + this.format;
                var dataUrl = this.$.signature.toDataURL(format);

                if (0 === dataUrl.indexOf('data:image/png') && 'image/png' !== format) {
                    throw new Error('The format "' + this.format + '" is not supported');
                }

                this.data = dataUrl.slice(dataUrl.indexOf(',') + 1);
            },

            getHeightWithoutUnit: function () {
                return parseInt(this.height.slice(0, this.height.indexOf('px')));
            },

            getWidthWithoutUnit: function () {
                return parseInt(this.width.slice(0, this.width.indexOf('px')));
            }
        });

    </script>

</dom-module>
